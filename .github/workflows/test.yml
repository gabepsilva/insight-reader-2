name: Test

on:
  push:
    branches: [main, "**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: [self-hosted, Linux]
    steps:
      - uses: actions/checkout@v4
        with:
          path: repo

      - name: Verify system dependencies are preinstalled on runner
        run: |
          missing=0

          for cmd in curl unzip pkg-config patchelf xdg-open; do
            if ! command -v "$cmd" >/dev/null 2>&1; then
              echo "Missing required command: $cmd"
              missing=1
            fi
          done

          for lib in openssl gtk+-3.0 ayatana-appindicator3-0.1 librsvg-2.0 alsa; do
            if ! pkg-config --exists "$lib"; then
              echo "Missing required pkg-config library: $lib"
              missing=1
            fi
          done

          if ! pkg-config --exists webkit2gtk-4.1 && ! pkg-config --exists webkit2gtk-4.0; then
            echo "Missing required pkg-config library: webkit2gtk-4.1 or webkit2gtk-4.0"
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            echo ""
            echo "Install required system dependencies once on the self-hosted runner, then re-run."
            exit 1
          fi

      - name: Install Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          rustup default stable
          rustup component add rustfmt clippy
          rustc --version
          cargo --version

      - name: Cache Rust and Tauri artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: repo/src-tauri -> target
          cache-directories: |
            ~/.cache/tauri
          cache-on-failure: true

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: repo/node_modules
          key: ${{ runner.os }}-bun-modules-${{ hashFiles('repo/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-modules-

      - name: Install dependencies
        run: bun install
        working-directory: repo

      - name: Type check
        run: bun run tsc --noEmit
        working-directory: repo

      - name: Run tests
        run: bun run test
        working-directory: repo

      - name: Check Rust formatting
        run: cargo fmt --all -- --check
        working-directory: repo/src-tauri

      - name: Lint Rust (deny warnings)
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: repo/src-tauri

      - name: Run Rust tests
        run: cargo test
        working-directory: repo/src-tauri

      - name: Build release (no bundles)
        run: bun run tauri build --no-bundle
        working-directory: repo
