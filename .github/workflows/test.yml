name: Test

on:
  push:
    branches: [main, "**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: [self-hosted, Linux]
    steps:
      - uses: actions/checkout@v4
        with:
          path: repo

      - name: Ensure system dependencies are available
        run: |
          has_missing=0

          check_deps() {
            has_missing=0

            for cmd in curl unzip pkg-config patchelf; do
              if ! command -v "$cmd" >/dev/null 2>&1; then
                echo "Missing required command: $cmd"
                has_missing=1
              fi
            done

            if command -v pkg-config >/dev/null 2>&1; then
              if ! pkg-config --exists openssl; then
                echo "Missing required pkg-config library: openssl"
                has_missing=1
              fi
              if ! pkg-config --exists gtk+-3.0; then
                echo "Missing required pkg-config library: gtk+-3.0"
                has_missing=1
              fi
              if ! pkg-config --exists librsvg-2.0; then
                echo "Missing required pkg-config library: librsvg-2.0"
                has_missing=1
              fi
              if ! pkg-config --exists alsa; then
                echo "Missing required pkg-config library: alsa"
                has_missing=1
              fi
              if ! pkg-config --exists ayatana-appindicator3-0.1 && ! pkg-config --exists appindicator3-0.1; then
                echo "Missing required pkg-config library: ayatana-appindicator3-0.1 or appindicator3-0.1"
                has_missing=1
              fi
              if ! pkg-config --exists webkit2gtk-4.1 && ! pkg-config --exists webkit2gtk-4.0; then
                echo "Missing required pkg-config library: webkit2gtk-4.1 or webkit2gtk-4.0"
                has_missing=1
              fi
            fi
          }

          check_deps

          if [ "$has_missing" -eq 1 ] && command -v apt-get >/dev/null 2>&1; then
            echo "Attempting automatic dependency install via apt-get..."

            if [ "$(id -u)" -eq 0 ]; then
              APT_PREFIX=""
            elif command -v sudo >/dev/null 2>&1 && sudo -n true >/dev/null 2>&1; then
              APT_PREFIX="sudo"
            else
              APT_PREFIX=""
            fi

            if [ -n "$APT_PREFIX" ] || [ "$(id -u)" -eq 0 ]; then
              $APT_PREFIX apt-get update

              WEBKIT_DEV_PACKAGE="libwebkit2gtk-4.1-dev"
              if ! apt-cache show "$WEBKIT_DEV_PACKAGE" >/dev/null 2>&1; then
                WEBKIT_DEV_PACKAGE="libwebkit2gtk-4.0-dev"
              fi

              APPINDICATOR_DEV_PACKAGE="libayatana-appindicator3-dev"
              if ! apt-cache show "$APPINDICATOR_DEV_PACKAGE" >/dev/null 2>&1; then
                APPINDICATOR_DEV_PACKAGE="libappindicator3-dev"
              fi

              $APT_PREFIX apt-get install -y \
                curl unzip build-essential pkg-config libssl-dev \
                libgtk-3-dev "$APPINDICATOR_DEV_PACKAGE" librsvg2-dev patchelf \
                "$WEBKIT_DEV_PACKAGE" libasound2-dev xdg-utils

              check_deps
            else
              echo "Cannot auto-install dependencies: runner user is not root and passwordless sudo is unavailable."
            fi
          fi

          if [ "$has_missing" -eq 1 ]; then
            echo ""
            echo "Install required system dependencies on the self-hosted runner (or configure passwordless sudo), then re-run."
            exit 1
          fi

      - name: Install Rust
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          rustup default stable
          rustup component add rustfmt clippy
          rustc --version
          cargo --version

      - name: Cache Rust and Tauri artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: repo/src-tauri -> target
          cache-directories: |
            ~/.cache/tauri
          cache-on-failure: true

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: repo/node_modules
          key: ${{ runner.os }}-bun-modules-${{ hashFiles('repo/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-modules-

      - name: Install dependencies
        run: bun install
        working-directory: repo

      - name: Type check
        run: bun run tsc --noEmit
        working-directory: repo

      - name: Run tests
        run: bun run test
        working-directory: repo

      - name: Check Rust formatting
        run: cargo fmt --all -- --check
        working-directory: repo/src-tauri

      - name: Lint Rust (deny warnings)
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: repo/src-tauri

      - name: Run Rust tests
        run: cargo test
        working-directory: repo/src-tauri

      - name: Build release (no bundles)
        run: bun run tauri build --no-bundle
        working-directory: repo
